{% extends "base.html" %}
{% load tags %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center">Search the HMS database</h1>
            <br />
            <br />
        </div>
    </div><!--class="row"-->

<div class="row">

<div class="col-md-6 col-md-offset-1">
<div class="well well-sm">
    <form role = "form" id="search-form" action="/fiddle/search" method="get">
    <div class="input-group">
        <input type="text" name="q" id="search-input" class="form-control" placeholder="Search for...">
        <span class="input-group-btn">
            <button class="btn btn-default" type="button">Go!</button>
        </span>
    </div>
    </form>
    <br />
    <p>Search for <kbd>*</kbd> to see the entire collection</p>

</div> <!--well well-sm-->



{% if content.params.q != 'None' %}


    <h4><br />{{ content.count }} result{{ content.count|pluralize }} found</h4>
<br />

{% for facet, values in content.facets.items %}

    {% if facet == 'type' %}

        {% if values|length > 1 %}

        <b>Show only results amongst:</b> 

            {% for name, count in values %}
                <button class="btn btn-primary facet-link" href="#" data-facet-name="{{ facet }}" data-facet-value="{{ name }}">{{ name|capfirst }} </a> <span class="badge">{{ count }}</span></button>
            {% endfor %}

        {% endif %}

    {% endif %}

{% endfor %}

    <br />
    <br />

    {% include "search/search_results.html" %}

    <nav>
        <ul class="pager">
            <li class="previous {% if content.previous == None %}disabled{% endif %}"><a href="{{ content.previous }}"><span aria-hidden="true">&larr;</span> Previous </a></li>
            <li class="next {% if content.next == None %}disabled{% endif %}"><a href="{{ content.next }}"><span aria-hidden="true">&rarr;</span> Next </a></li>
        </ul>
    </nav>


</div> <!--col-md-6-->

    <div class="col-md-4">

        {% include "search/faceting.html" %}

    </div> <!--col-md-4-->

</div> <!-- row -->
</div>

{% endif %}
{% endblock %}

{% block scripts %}

<script type="text/javascript">
    // this code manages what happens when a facet link is clicked.
    $(".facet-link").on('click', function(e)
    {
        var qstr = window.location.search.replace("?limit=10&offset=10", "");
        var qstr_params = $.parseParams(qstr);
        var facetName = $(this).data('facet-name');
        var facetValue = $(this).data('facet-value');
        if (!(facetName in qstr_params))
        {
            var facetQ = facetName + "=" + facetValue;
            if (qstr != "")
            {
                // this makes sure that we either append the
                // querystring to an existing query string
                // (with a "&") or we just append it to the
                // existing URL.
                facetQ = "&" + facetQ;
            }
            window.location.search = qstr + facetQ;
        }
        e.preventDefault();
    });
</script>
{% endblock %}